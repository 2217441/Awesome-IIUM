---
/**
 * CampusMap component
 *
 * Purpose: Interactive map with campus tabs and location markers.
 * Usage: <CampusMap /> on the dashboard page.
 * Props: None.
 * Client behavior: Loads MapLibre GL and hydrates map interactions.
 * API dependencies: MapLibre GL JS (tile and map assets).
 */

interface Campus {
	id: string;
	name: string;
	nameMs: string;
	center: [number, number];
	zoom: number;
	color: string;
}

interface Location {
	name: string;
	type:
		| 'kulliyyah'
		| 'library'
		| 'cafeteria'
		| 'mosque'
		| 'admin'
		| 'sport'
		| 'hostel';
	coords: [number, number];
	icon: string;
	campus: string;
}

// biome-ignore lint/correctness/noUnusedVariables: passed to client script via define:vars
const campuses: Campus[] = [
	{
		id: 'gombak',
		name: 'Main Campus (Gombak)',
		nameMs: 'Kampus Utama (Gombak)',
		center: [101.7313, 3.2513],
		zoom: 15,
		color: '#10b981',
	},
	{
		id: 'kuantan',
		name: 'Kuantan Campus',
		nameMs: 'Kampus Kuantan',
		center: [103.426, 3.8177],
		zoom: 15,
		color: '#3b82f6',
	},
	{
		id: 'pagoh',
		name: 'Pagoh Campus',
		nameMs: 'Kampus Pagoh',
		center: [102.7681, 2.1494],
		zoom: 15,
		color: '#f59e0b',
	},
];

// biome-ignore lint/correctness/noUnusedVariables: passed to client script via define:vars
const locations: Location[] = [
	// Gombak Campus
	{
		name: 'KICT',
		type: 'kulliyyah',
		coords: [101.734, 3.252],
		icon: 'üíª',
		campus: 'gombak',
	},
	{
		name: 'KENMS',
		type: 'kulliyyah',
		coords: [101.73, 3.253],
		icon: 'üìä',
		campus: 'gombak',
	},
	{
		name: 'KOE',
		type: 'kulliyyah',
		coords: [101.732, 3.25],
		icon: '‚öôÔ∏è',
		campus: 'gombak',
	},
	{
		name: 'KIRKHS',
		type: 'kulliyyah',
		coords: [101.728, 3.254],
		icon: 'üìö',
		campus: 'gombak',
	},
	{
		name: 'Dar al-Hikmah Library',
		type: 'library',
		coords: [101.731, 3.2515],
		icon: 'üìñ',
		campus: 'gombak',
	},
	{
		name: 'Main Mosque',
		type: 'mosque',
		coords: [101.7305, 3.2525],
		icon: 'üïå',
		campus: 'gombak',
	},
	{
		name: 'Mahallah Ali',
		type: 'hostel',
		coords: [101.735, 3.248],
		icon: 'üè†',
		campus: 'gombak',
	},
	{
		name: 'Mahallah Bilal',
		type: 'hostel',
		coords: [101.736, 3.249],
		icon: 'üè†',
		campus: 'gombak',
	},
	// Kuantan Campus
	{
		name: 'KOM',
		type: 'kulliyyah',
		coords: [103.427, 3.818],
		icon: 'üè•',
		campus: 'kuantan',
	},
	{
		name: 'KOD',
		type: 'kulliyyah',
		coords: [103.425, 3.819],
		icon: 'ü¶∑',
		campus: 'kuantan',
	},
	{
		name: 'KOP',
		type: 'kulliyyah',
		coords: [103.428, 3.817],
		icon: 'üíä',
		campus: 'kuantan',
	},
	{
		name: 'Sultan Haji Ahmad Shah Library',
		type: 'library',
		coords: [103.426, 3.8175],
		icon: 'üìñ',
		campus: 'kuantan',
	},
	// Pagoh Campus
	{
		name: 'KLM',
		type: 'kulliyyah',
		coords: [102.769, 2.15],
		icon: 'üó£Ô∏è',
		campus: 'pagoh',
	},
	{
		name: 'Pagoh Library',
		type: 'library',
		coords: [102.768, 2.149],
		icon: 'üìñ',
		campus: 'pagoh',
	},
];
---

<div class="campus-map not-content">
  <div class="map-header">
    <h3>üó∫Ô∏è Campus Map</h3>
    <div class="campus-tabs" role="tablist">
      {campuses.map((campus, i) => (
        <button 
          class={`campus-tab ${i === 0 ? 'active' : ''}`}
          data-campus={campus.id}
          style={`--campus-color: ${campus.color}`}
          role="tab"
          aria-selected={i === 0}
        >
          {campus.name}
        </button>
      ))}
    </div>
  </div>

  <div id="map-container" class="map-container">
    <div id="map" class="map"></div>
    <div class="map-loading">Loading map...</div>
    {/* Accessible hidden container for keyboard navigation */}
    <div id="a11y-markers" class="sr-only"></div>
  </div>

  <div class="legend">
    <span class="legend-item"><span class="icon">üíª</span> Kulliyyah</span>
    <span class="legend-item"><span class="icon">üìñ</span> Library</span>
    <span class="legend-item"><span class="icon">üïå</span> Mosque</span>
    <span class="legend-item"><span class="icon">üè†</span> Hostel</span>
  </div>

  <p class="map-note">
    üìç Click markers for details ‚Ä¢ Use scroll to zoom ‚Ä¢ Drag to pan
  </p>
</div>

<script type="module" define:vars={{ campuses, locations }}>
  // Helper to prevent XSS
  function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return unsafe;
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  // Dynamically load MapLibre GL JS
  async function loadMapLibre() {
    if (window.maplibregl) return window.maplibregl;

    const scriptSrc = 'https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js';
    let script = document.querySelector(`script[src="${scriptSrc}"]`);

    if (!script) {
      // Add CSS
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css';
      link.integrity = 'sha384-MinO0mNliZ3vwppuPOUnGa+iq619pfMhLVUXfC4LHwSCvF9H+6P/KO4Q7qBOYV5V';
      link.crossOrigin = 'anonymous';
      document.head.appendChild(link);

      // Add JS
      script = document.createElement('script');
      script.src = scriptSrc;
      script.integrity = 'sha384-SYKAG6cglRMN0RVvhNeBY0r3FYKNOJtznwA0v7B5Vp9tr31xAHsZC0DqkQ/pZDmj';
      script.crossOrigin = 'anonymous';
      document.head.appendChild(script);
    }

    return new Promise((resolve, reject) => {
      if (window.maplibregl) {
        resolve(window.maplibregl);
      } else {
        script.addEventListener('load', () => resolve(window.maplibregl));
        script.addEventListener('error', () => reject(new Error('Failed to load MapLibre')));
      }
    });
  }

  async function initMap() {
    let maplibregl;
    const loading = document.querySelector('.map-loading');
    try {
      maplibregl = await loadMapLibre();
    } catch (e) {
      if (loading) loading.textContent = 'Map failed to load (offline?)';
      console.error(e);
      return;
    }

    const mapContainer = document.getElementById('map');
    const a11yContainer = document.getElementById('a11y-markers');

    if (!mapContainer) return;

    const defaultCampus = campuses[0];

    // Initialize map with OpenStreetMap tiles
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          'osm': {
            type: 'raster',
            tiles: [
              'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
            ],
            tileSize: 256,
            attribution: '¬© OpenStreetMap contributors'
          }
        },
        layers: [{
          id: 'osm',
          type: 'raster',
          source: 'osm',
          minzoom: 0,
          maxzoom: 19
        }]
      },
      center: defaultCampus.center,
      zoom: defaultCampus.zoom,
      // Ensure local fonts are used for emoji rendering
      localIdeographFontFamily: "'sans-serif', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'"
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    const popup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false,
      offset: 25
    });

    map.on('load', () => {
      // Add GeoJSON source
      map.addSource('locations', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });

      // Layer: Shadow (simulated with blur)
      map.addLayer({
        id: 'marker-shadow',
        type: 'circle',
        source: 'locations',
        paint: {
          'circle-color': '#000000',
          'circle-radius': 16,
          'circle-blur': 0.6,
          'circle-opacity': 0.2,
          'circle-translate': [0, 4]
        }
      });

      // Layer: Background Circle (White)
      map.addLayer({
        id: 'marker-bg',
        type: 'circle',
        source: 'locations',
        paint: {
          'circle-color': '#ffffff',
          'circle-radius': [
            'case',
            ['boolean', ['feature-state', 'hover'], false],
            19, // Hover size
            16  // Normal size
          ],
          'circle-stroke-width': 0, // No border needed as shadow provides contrast
        }
      });

      // Layer: Icon (Emoji)
      map.addLayer({
        id: 'marker-icon',
        type: 'symbol',
        source: 'locations',
        layout: {
          'text-field': ['get', 'icon'],
          'text-size': 18,
          'text-allow-overlap': true,
          'text-font': ['Open Sans Regular'] // Fallback, but localIdeographFontFamily overrides
        },
        paint: {
          'text-color': '#000000'
        }
      });

      // Handle interactions
      map.on('mouseenter', 'marker-bg', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        if (e.features.length > 0) {
          map.setFeatureState(
            { source: 'locations', id: e.features[0].id },
            { hover: true }
          );
        }
      });

      map.on('mouseleave', 'marker-bg', (e) => {
        map.getCanvas().style.cursor = '';
        // Reset all hover states (simplification, or track hoveredId)
        // Since we don't track hoveredId globally here easily without variable,
        // we can just reset if we knew the ID.
        // Better:
        if (e.features.length > 0) { // e.features might be empty on leave
           // actually 'mouseleave' event features array might be empty.
        }
        // Safest: queryRenderedFeatures or just rely on state logic
        // Let's implement robust hover state
      });

      let hoveredStateId = null;
      map.on('mousemove', 'marker-bg', (e) => {
        if (e.features.length > 0) {
          if (hoveredStateId !== null) {
            map.setFeatureState(
              { source: 'locations', id: hoveredStateId },
              { hover: false }
            );
          }
          hoveredStateId = e.features[0].id;
          map.setFeatureState(
            { source: 'locations', id: hoveredStateId },
            { hover: true }
          );
        }
      });
      map.on('mouseleave', 'marker-bg', () => {
        if (hoveredStateId !== null) {
          map.setFeatureState(
            { source: 'locations', id: hoveredStateId },
            { hover: false }
          );
        }
        hoveredStateId = null;
        map.getCanvas().style.cursor = '';
      });

      map.on('click', 'marker-bg', (e) => {
        const feature = e.features[0];
        const coordinates = feature.geometry.coordinates.slice();
        const { name, icon, type } = feature.properties;

        // Ensure we click on the top rendered feature
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        showPopup(coordinates, icon, name, type);
      });

      // Initial markers
      const activeTab = document.querySelector('.campus-tab.active');
      const initialCampusId = activeTab ? activeTab.dataset.campus : defaultCampus.id;
      updateMarkers(initialCampusId);
      loading.style.display = 'none';
    });

    function showPopup(coords, icon, name, type) {
        popup.setLngLat(coords)
          .setHTML(`
            <div class="marker-popup">
              <strong>${escapeHtml(icon)} ${escapeHtml(name)}</strong>
              <span class="type">${escapeHtml(type)}</span>
            </div>
          `)
          .addTo(map);
    }

    function updateMarkers(campusId) {
      const campusLocations = locations.filter(loc => loc.campus === campusId);

      const features = campusLocations.map((loc, index) => ({
        type: 'Feature',
        id: index, // Numeric ID for feature state
        geometry: {
          type: 'Point',
          coordinates: loc.coords
        },
        properties: {
          name: loc.name,
          icon: loc.icon,
          type: loc.type,
          campus: loc.campus
        }
      }));

      const source = map.getSource('locations');
      if (source) {
        source.setData({
          type: 'FeatureCollection',
          features: features
        });
      }

      // Update accessibility buttons
      if (a11yContainer) {
        a11yContainer.innerHTML = '';
        campusLocations.forEach((loc, index) => {
            const btn = document.createElement('button');
            btn.textContent = `${loc.icon} ${loc.name}`;
            btn.setAttribute('aria-label', `View ${loc.name}`);
            btn.className = 'sr-only-marker-btn';

            // Focus handler
            btn.addEventListener('focus', () => {
                if (!map.getSource('locations')) return;

                map.flyTo({ center: loc.coords, zoom: 16 });
                showPopup(loc.coords, loc.icon, loc.name, loc.type);
                // Highlight the marker visually
                if (window.lastFocusedId !== undefined) {
                     map.setFeatureState({ source: 'locations', id: window.lastFocusedId }, { hover: false });
                }
                map.setFeatureState({ source: 'locations', id: index }, { hover: true });
                window.lastFocusedId = index;
            });

            // Allow clicking via keyboard (Enter/Space)
            btn.addEventListener('click', () => {
                // Focus triggers everything, so click just needs to ensure focus?
                // Or maybe focus shouldn't flyTo if it's just tabbing through?
                // Usually map interaction: tabbing moves focus, but doesn't necessarily move map unless selected.
                // But for "hidden markers", users can't see where focus is unless map moves.
                // So "flyTo" on focus is appropriate for this pattern.
            });

            a11yContainer.appendChild(btn);
        });
      }
    }

    // Campus tab switching
    document.querySelectorAll('.campus-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const campusId = tab.dataset.campus;
        const campus = campuses.find(c => c.id === campusId);

        if (!campus) return;

        // Update active tab
        document.querySelectorAll('.campus-tab').forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');

        // Fly to campus
        map.flyTo({
          center: campus.center,
          zoom: campus.zoom,
          duration: 1500
        });

        // Update markers
        updateMarkers(campusId);
      });
    });
  }

  // Lazy load map when it comes into view
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        initMap();
        observer.disconnect();
      }
    });
  }, { rootMargin: '200px' });

  const mapContainer = document.getElementById('map-container');
  if (mapContainer) {
    observer.observe(mapContainer);
  }
</script>

<style>
  .campus-map {
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-hairline-light);
    border-radius: 12px;
    padding: 1.25rem;
    margin: 1.5rem 0;
  }

  .map-header {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .map-header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
  }

  .campus-tabs {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .campus-tab {
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--sl-color-hairline-light);
    border-radius: 6px;
    background: var(--sl-color-bg);
    color: inherit;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .campus-tab:hover {
    border-color: var(--campus-color, var(--sl-color-accent));
  }

  .campus-tab.active {
    background: var(--campus-color, var(--sl-color-accent));
    border-color: var(--campus-color, var(--sl-color-accent));
    color: #0f172a;
  }

  .map-container {
    position: relative;
    height: 350px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--sl-color-bg);
  }

  .map {
    width: 100%;
    height: 100%;
  }

  .map-loading {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--sl-color-bg);
    color: var(--sl-color-gray-3);
    font-size: 0.875rem;
  }

  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 0.75rem;
    font-size: 0.75rem;
    color: var(--sl-color-gray-3);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .legend-item .icon {
    font-size: 0.875rem;
  }

  .map-note {
    margin: 0.75rem 0 0 0;
    font-size: 0.625rem;
    color: var(--sl-color-gray-2);
    text-align: center;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  :global(.marker-popup) {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.25rem;
  }

  :global(.marker-popup strong) {
    font-size: 0.875rem;
  }

  :global(.marker-popup .type) {
    font-size: 0.625rem;
    color: #666;
    text-transform: capitalize;
  }

  :global(.maplibregl-popup-content) {
    border-radius: 8px;
    padding: 0.5rem;
  }
</style>
